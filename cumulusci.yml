minimum_cumulusci_version: '3.84.3'
project:
    name: rlm-base
    package:
        name: rlm-base
        api_version: '61.0'
    git:
        default_branch: 'main'
    source_format: sfdx

    custom:
        rlm_psl_api_names: &rlm_psl_api_names
            - RevenueLifecycleManagementUserPsl
            - OmniStudioDesigner
            - CorePricingDesignTime
            - BREDesigner
            - DocGenDesignerPsl
            - ClauseManagementUser
            - ProductCatalogManagementAdministratorPsl
            - ContractManagementUser
            - ProductDiscoveryUserPsl
            - BRERuntime
            - IndustriesConfiguratorPsl
            - ObligationManagementUser
            - Microsoft365WordPsl

        sales_transaction_context_name: &sales_transaction_context_name
            RLM_SalesTransactionContext

        product_discovery_context_name: &product_discovery_context_name
            RLM_ProductDiscoveryContext

        create_partner_community: true

tasks:
    robot:
        options:
            suites: robot/rlm-base/tests
            options:
                outputdir: robot/rlm-base/results

    robot_testdoc:
        options:
            path: robot/rlm-base/tests
            output: robot/rlm-base/doc/rlm-base_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 75
    
    extend_stdctx:
        description: Extend Standard Sales Transaction Context Definition
        class_path: tasks.extend_stdctx.ExtendStandardContext
        group: Revenue Lifecycle Management

    extend_stdctx_pd:
        description: Extend Standard Product Discovery Context Definition
        class_path: tasks.extend_stdctx_pd.ExtendStandardContextPd
        group: Revenue Lifecycle Management

    deploy_permissions:
        description: Runs deployment against the permission set group file for Revenue Cloud.
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/permissionsetgroups
  
    deploy_decision_tables:
        description: Decision Tables are required to be deployed first before other metadata -- this prioritizes this deployment first
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/decisionTables

    deploy_context_definitions:
        description: Context Definitions need to be deployed and activated before other metadata -- this prioritizes this deployment first
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/contextDefinitions

    deploy_expression_sets:
        description: Expression Sets need to be deployed and activated before other metadata -- this prioritizes this deployment first
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/expressionSetDefinition
            transforms:
            - transform: find_replace
              options:
                patterns:
                - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__ATTRIBUTEPasID__"]
                  replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Attribute Based Adjustment' LIMIT 1
                  api: rest
                - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__VOLUMEPasID__"]
                  replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Price Adjustment Tier' LIMIT 1
                  api: rest
                - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__BUNDLEPasID__"]
                  replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Bundle Based Adjustment' LIMIT 1
                  api: rest

    deploy_relationship_graphs:
        description: Relationship Graphs need to be deployed and activated before other metadata -- this prioritizes this deployment first
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/relationshipGraphDefinitions

    deploy_org_settings:
        description: Org Settings need to be deployed and activated before other metadata -- this prioritizes this deployment first
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Revenue Lifecycle Management
        options:
            path: force-app/main/default/settings

    extendSalesContext:
        description: Extend Standard Sales Transaction Context
        class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
        options:
            name: *sales_transaction_context_name
            description: "Extension of Standard Sales Transaction Context Definition"
            developerName: *sales_transaction_context_name
            baseReference: "SalesTransactionContext__stdctx"
            startDate: "2024-01-01T00:00:00.000Z"
            contextTtl: 20

    extendProductDiscoveryContext:
        description: Extend Standard Product Discovery Context
        class_path: tasks.rlm_extend_stdctx.ExtendStandardContext
        options:
            name: *product_discovery_context_name
            description: "Extension of Standard Product Discovery Context Definition"
            developerName: *product_discovery_context_name
            baseReference: "ProductDiscoveryContext__stdctx"
            startDate: "2024-01-01T00:00:00.000Z"
            contextTtl: 20

    createPartnerCentral:
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            name: "rlm"
            description: "RLM Partner Digital Experience"
            template: "Build Your Own"
            skip_existing: true

flows:
    insert_data:
        group: Revenue Lifecycle Management
        steps:
            1:
                task: dx
                options:
                    command: 'sfdmu run -s csvfile -p datasets/sfdmu/multicurrency'

    prepare_core:
        group: Revenue Lifecycle Management
        steps:
            1:
                task: assign_permission_set_licenses
                options:
                    api_names: *rlm_psl_api_names
            2:
                task: deploy_org_settings
            3:
                task: deploy_decision_tables
            4:
                task: deploy_permissions
            5:
                task: util_sleep
                options:
                    seconds: 20
                ui_options:
                    name: Wait for Permission Set Groups to Update
            6:
                task: assign_permission_set_groups
                options:
                    api_names: RLM_PSL,RLM_NGP,RLM_CLM

    extend_context_definitions:
        group: Revenue Lifecycle Management
        steps:
            1:
                task: extend_stdctx
            2:
                task: extend_stdctx_pd

    prepare_rlm_org:
        group: Revenue Lifecycle Management
        steps:
            1:
                flow: prepare_core
            2:
                task: createPartnerCentral
                when: project_config.project__custom__create_partner_community == true
            3:
                flow: extend_context_definitions
            4:
                task: deploy_expression_sets
            5:
                task: util_sleep
                options:
                    seconds: 40
            6:
                task: deploy_relationship_graphs
            7:
                task: deploy
                options:
                    path: force-app/main/default
                    transforms:
                    - transform: find_replace
                      options:
                        patterns:
                        - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__ATTRIBUTEPasID__"]
                          replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Attribute Based Adjustment' LIMIT 1
                          api: rest
                        - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__VOLUMEPasID__"]
                          replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Price Adjustment Tier' LIMIT 1
                          api: rest
                        - xpath: //ExpressionSetDefinition/versions/variables/value[text()="__BUNDLEPasID__"]
                          replace_record_id_query: SELECT Id from PriceAdjustmentSchedule WHERE name = 'Standard Bundle Based Adjustment' LIMIT 1
                          api: rest
            8:
                task: publish_community
                when: project_config.project__custom__create_partner_community == true
                options:
                    name: rlm
            9:
                flow: insert_data